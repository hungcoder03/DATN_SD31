<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gi·ªè H√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .product-img {
            width: 80px;
            height: auto;
            border-radius: 8px;
        }
        .quantity-input {
            width: 60px;
        }
        /* ƒê∆∞a checkbox v√†o c·ªôt ƒë·∫ßu ti√™n */
        table thead tr th:first-child,
        table tbody tr td:first-child {
            width: 40px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">üõí Gi·ªè H√†ng C·ªßa B·∫°n</h2>

    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="chonTatCa" />
        <label class="form-check-label fw-bold" for="chonTatCa">Ch·ªçn t·∫•t c·∫£</label>
    </div>

    <table class="table table-bordered align-middle">
        <thead class="table-dark">
        <tr>
            <th></th> <!-- c·ªôt checkbox -->
            <th>#</th>
            <th>·∫¢nh</th>
            <th>S·∫£n Ph·∫©m</th>
            <th>Size</th>
            <th>M√†u s·∫Øc</th>
            <th>Gi√°</th>
            <th>S·ªë L∆∞·ª£ng</th>
            <th>Th√†nh Ti·ªÅn</th>
            <th>Tr·∫°ng Th√°i</th>
            <th>H√†nh ƒê·ªông</th>
        </tr>
        </thead>
        <tbody>
        <!-- L·∫∑p qua danh s√°ch gi·ªè h√†ng -->
        <tr th:each="item, iterStat : ${list}"
            th:data-price="${item.chiTietSanPham.giaBan}"
            th:data-soluong="${item.soluong}">
            <td class="text-center">
                <input type="checkbox" class="item-checkbox" />
            </td>
            <td th:text="${iterStat.count}">1</td>

            <!-- ·∫¢nh s·∫£n ph·∫©m -->
            <td>
                <img th:src="@{${item.chiTietSanPham.sanpham.hinhAnhs[0].url}}" alt="·∫¢nh" class="product-img" />
            </td>

            <!-- T√™n s·∫£n ph·∫©m -->

            <td th:text="${item.chiTietSanPham.sanpham.ten}">T√™n s·∫£n ph·∫©m</td>

            <td th:text="${item.chiTietSanPham.size.ten}"></td>

            <td th:text="${item.chiTietSanPham.mausac.ten}"></td>
            <!-- Gi√° ƒë∆°n v·ªã -->
            <td th:text="${item.chiTietSanPham.giaBan} + '‚Ç´'">0‚Ç´</td>

            <!-- S·ªë l∆∞·ª£ng -->
            <td>
                <form th:action="@{'/gio-hang/cap-nhat/' + ${item.id}}" method="post" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="soluong" th:value="${item.soluong}" />
                    <button type="submit" name="action" value="decrease" class="btn btn-outline-secondary btn-sm">-</button>

                    <input type="number" name="newSoluong" class="form-control text-center quantity-input" th:value="${item.soluong}" min="1" />

                    <button type="submit" name="action" value="increase" class="btn btn-outline-secondary btn-sm">+</button>
                </form>
            </td>

            <!-- Th√†nh ti·ªÅn -->
            <td class="line-total" th:text="${item.thanhtien} + '‚Ç´'">0‚Ç´</td>

            <!-- Tr·∫°ng th√°i -->
            <td>
                <span th:switch="${item.trangthai}">
                  <span th:case="0" class="badge bg-secondary">M·ªõi</span>
                  <span th:case="1" class="badge bg-success">ƒê√£ x√°c nh·∫≠n</span>
                  <span th:case="2" class="badge bg-danger">ƒê√£ h·ªßy</span>
                  <span th:case="*">Kh√¥ng x√°c ƒë·ªãnh</span>
                </span>
            </td>

            <!-- H√†nh ƒë·ªông -->
            <td>
                <a class="btn btn-danger btn-sm" th:href="@{'/gio-hang/xoa/' + ${item.id}}" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?');">X√≥a</a>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- T·ªïng ti·ªÅn v√† n√∫t thanh to√°n -->
    <div class="row mt-4">
        <div class="col-md-6">
            <a th:href="@{/admin/san-pham/khach-hang/danh-sach}" class="btn btn-secondary">‚Üê Ti·∫øp t·ª•c mua s·∫Øm</a>
        </div>
        <div class="col-md-6 text-end">
            <h5 class="mb-3">
                T·ªïng ti·ªÅn:
                <span id="totalTien" class="text-danger fw-bold" th:text="${#numbers.formatDecimal(tongTien, 0, 'COMMA', 2, 'POINT')} + '‚Ç´'">0‚Ç´</span>
            </h5>
            <a th:href="@{/thanh-toan}" class="btn btn-success btn-lg">üîí Thanh To√°n</a>
        </div>
    </div>
</div>

<!-- Script t·ª± ƒë·ªông submit form khi thay ƒë·ªïi s·ªë l∆∞·ª£ng -->
<script>
    document.querySelectorAll('input[name="newSoluong"]').forEach(input => {
        input.addEventListener('change', function() {
            if (this.value < 1) {
                this.value = 1;
            }
            this.closest('form').submit();
        });
    });
</script>

<!-- Script x·ª≠ l√Ω ch·ªçn s·∫£n ph·∫©m v√† t√≠nh t·ªïng ti·ªÅn -->
<script>
    function formatMoney(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "‚Ç´";
    }

    function parseFormattedMoney(formatted) {
        return Number(formatted.replace(/[‚Ç´,]/g, ''));
    }

    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn d·ª±a tr√™n checkbox ƒë√£ ch·ªçn
    function updateTotalTien() {
        let total = 0;
        document.querySelectorAll('tbody tr').forEach(tr => {
            const checkbox = tr.querySelector('input.item-checkbox');
            if(checkbox && checkbox.checked) {
                const price = parseInt(tr.getAttribute('data-price'));
                // L·∫•y s·ªë l∆∞·ª£ng t·ª´ input trong form
                const quantityInput = tr.querySelector('input[name="newSoluong"]');
                const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
                total += price * quantity;
            }
        });
        document.getElementById('totalTien').textContent = formatMoney(total);
    }

    // B·∫Øt s·ª± ki·ªán cho checkbox ch·ªçn t·∫•t c·∫£ v√† t·ª´ng checkbox
    document.addEventListener('DOMContentLoaded', function () {
        const chonTatCa = document.getElementById('chonTatCa');
        const itemCheckboxes = document.querySelectorAll('input.item-checkbox');

        // Khi click ch·ªçn t·∫•t c·∫£
        chonTatCa.addEventListener('change', function() {
            itemCheckboxes.forEach(cb => cb.checked = this.checked);
            updateTotalTien();
        });

        // Khi ch·ªçn/b·ªè ch·ªçn t·ª´ng s·∫£n ph·∫©m
        itemCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                // N·∫øu c√≥ checkbox n√†o ch∆∞a ch·ªçn th√¨ b·ªè ch·ªçn checkbox ch·ªçn t·∫•t c·∫£
                if (!this.checked) {
                    chonTatCa.checked = false;
                } else {
                    // N·∫øu t·∫•t c·∫£ checkbox ƒë·ªÅu ƒë∆∞·ª£c ch·ªçn th√¨ t√≠ch checkbox ch·ªçn t·∫•t c·∫£
                    const allChecked = Array.from(itemCheckboxes).every(cb => cb.checked);
                    chonTatCa.checked = allChecked;
                }
                updateTotalTien();
            });
        });

        // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn ngay khi trang load
        updateTotalTien();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
